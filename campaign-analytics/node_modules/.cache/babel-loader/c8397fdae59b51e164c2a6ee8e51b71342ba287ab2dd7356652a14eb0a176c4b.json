{"ast":null,"code":"// dataTransforms.js\nimport _ from \"lodash\";\n\n// 共用的工具函數\nconst parseCurrencyValue = value => {\n  return parseFloat(value.replace(\"$\", \"\")) || 0;\n};\nconst calculateRate = (numerator, denominator, decimals = 2) => {\n  return denominator > 0 ? (numerator / denominator * 100).toFixed(decimals) : null;\n};\nconst getDateKey = (dateStr, timeGranularity) => {\n  const date = new Date(dateStr);\n  switch (timeGranularity) {\n    case \"hour\":\n      {\n        // 確保每個小時都有獨立數據\n        const formattedHour = String(hour || 0).padStart(2, \"0\");\n        return `${dateStr} ${formattedHour}:00`;\n      }\n    case \"week\":\n      {\n        const weekStart = new Date(date);\n        weekStart.setDate(date.getDate() - date.getDay());\n        return weekStart.toISOString().split(\"T\")[0];\n      }\n    case \"month\":\n      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, \"0\")}`;\n    default:\n      // day\n      return dateStr;\n  }\n};\nconst findBestPerformers = stats => {\n  return {\n    highestROAS: _.maxBy(stats, \"ROAS\"),\n    lowestACOS: _.minBy(stats.filter(c => parseFloat(c.ACOS) > 0), \"ACOS\"),\n    highestCTR: _.maxBy(stats, c => parseFloat(c.CTR)),\n    highestConversion: _.maxBy(stats, c => parseFloat(c.conversionRate))\n  };\n};\n\n// 主要的導出函數\nexport const processCampaignData = data => {\n  if (!Array.isArray(data)) {\n    console.error(\"Input data is not an array\");\n    return {\n      stats: [],\n      best: null\n    };\n  }\n  const stats = _(data).groupBy(\"Campaign Name\").map((campaign, name) => {\n    const totalImpressions = _.sumBy(campaign, \"Impressions\");\n    const totalClicks = _.sumBy(campaign, \"Clicks\");\n    const totalOrders = _.sumBy(campaign, \"7 Day Total Orders (#)\");\n    const totalSpend = _.sumBy(campaign, row => parseCurrencyValue(row[\"Spend\"]));\n    const totalSales = _.sumBy(campaign, row => parseCurrencyValue(row[\"7 Day Total Sales \"]));\n    return {\n      name,\n      impressions: totalImpressions,\n      clicks: totalClicks,\n      orders: totalOrders,\n      spend: totalSpend,\n      sales: totalSales,\n      CTR: calculateRate(totalClicks, totalImpressions),\n      CPC: totalClicks ? (totalSpend / totalClicks).toFixed(2) : 0,\n      ACOS: calculateRate(totalSpend, totalSales),\n      ROAS: totalSpend ? (totalSales / totalSpend).toFixed(2) : 0,\n      conversionRate: calculateRate(totalOrders, totalClicks)\n    };\n  }).value();\n  return {\n    stats,\n    best: findBestPerformers(stats)\n  };\n};\n\n// 添加時間格式化函數\nconst formatDateTime = (date, hour) => {\n  // 確保 hour 是字符串且至少兩位數\n  const paddedHour = String(hour || \"00\").padStart(2, \"0\");\n  return `${date} ${paddedHour}:00:00`;\n};\nexport const processTrendData = (data, timeGranularity = \"day\", compareMode = \"combined\") => {\n  if (!Array.isArray(data)) {\n    console.error(\"Input data is not an array\");\n    return [];\n  }\n  return _(data).groupBy(row => {\n    if (timeGranularity === \"hour\") {\n      // 使用 Start Date 和 Hour 組合作為分組依據\n      return formatDateTime(row[\"Start Date\"], row[\"Hour\"]);\n    }\n    const date = new Date(row[\"Start Date\"]);\n    switch (timeGranularity) {\n      case \"week\":\n        const weekStart = new Date(date);\n        weekStart.setDate(date.getDate() - date.getDay());\n        return weekStart.toISOString().split(\"T\")[0];\n      case \"month\":\n        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, \"0\")}`;\n      default:\n        // day\n        return row[\"Start Date\"];\n    }\n  }).map((group, dateTime) => {\n    // 計算該時間點的總計數據\n    const totalSales = _.sumBy(group, row => parseCurrencyValue(row[\"7 Day Total Sales \"]));\n    const totalSpend = _.sumBy(group, row => parseCurrencyValue(row[\"Spend\"]));\n    const result = {\n      date: dateTime,\n      sales: totalSales,\n      spend: totalSpend,\n      ACOS: totalSales > 0 ? (totalSpend / totalSales * 100).toFixed(2) : null\n    };\n\n    // 如果是分開比較模式，添加各活動的數據\n    if (compareMode === \"separate\") {\n      result.campaignData = _(group).groupBy(\"Campaign Name\").mapValues(campaignGroup => ({\n        sales: _.sumBy(campaignGroup, row => parseCurrencyValue(row[\"7 Day Total Sales \"])),\n        spend: _.sumBy(campaignGroup, row => parseCurrencyValue(row[\"Spend\"]))\n      })).value();\n    }\n    return result;\n  }).orderBy([\"date\"], [\"asc\"]).value();\n};","map":{"version":3,"names":["_","parseCurrencyValue","value","parseFloat","replace","calculateRate","numerator","denominator","decimals","toFixed","getDateKey","dateStr","timeGranularity","date","Date","formattedHour","String","hour","padStart","weekStart","setDate","getDate","getDay","toISOString","split","getFullYear","getMonth","findBestPerformers","stats","highestROAS","maxBy","lowestACOS","minBy","filter","c","ACOS","highestCTR","CTR","highestConversion","conversionRate","processCampaignData","data","Array","isArray","console","error","best","groupBy","map","campaign","name","totalImpressions","sumBy","totalClicks","totalOrders","totalSpend","row","totalSales","impressions","clicks","orders","spend","sales","CPC","ROAS","formatDateTime","paddedHour","processTrendData","compareMode","group","dateTime","result","campaignData","mapValues","campaignGroup","orderBy"],"sources":["C:/python-training/eyeglad/campaign-analytics/src/utils/dataTransforms.js"],"sourcesContent":["// dataTransforms.js\r\nimport _ from \"lodash\";\r\n\r\n// 共用的工具函數\r\nconst parseCurrencyValue = (value) => {\r\n  return parseFloat(value.replace(\"$\", \"\")) || 0;\r\n};\r\n\r\nconst calculateRate = (numerator, denominator, decimals = 2) => {\r\n  return denominator > 0\r\n    ? ((numerator / denominator) * 100).toFixed(decimals)\r\n    : null;\r\n};\r\n\r\nconst getDateKey = (dateStr, timeGranularity) => {\r\n  const date = new Date(dateStr);\r\n\r\n  switch (timeGranularity) {\r\n    case \"hour\": {\r\n      // 確保每個小時都有獨立數據\r\n      const formattedHour = String(hour || 0).padStart(2, \"0\");\r\n      return `${dateStr} ${formattedHour}:00`;\r\n    }\r\n    case \"week\": {\r\n      const weekStart = new Date(date);\r\n      weekStart.setDate(date.getDate() - date.getDay());\r\n      return weekStart.toISOString().split(\"T\")[0];\r\n    }\r\n    case \"month\":\r\n      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(\r\n        2,\r\n        \"0\"\r\n      )}`;\r\n    default: // day\r\n      return dateStr;\r\n  }\r\n};\r\n\r\nconst findBestPerformers = (stats) => {\r\n  return {\r\n    highestROAS: _.maxBy(stats, \"ROAS\"),\r\n    lowestACOS: _.minBy(\r\n      stats.filter((c) => parseFloat(c.ACOS) > 0),\r\n      \"ACOS\"\r\n    ),\r\n    highestCTR: _.maxBy(stats, (c) => parseFloat(c.CTR)),\r\n    highestConversion: _.maxBy(stats, (c) => parseFloat(c.conversionRate)),\r\n  };\r\n};\r\n\r\n// 主要的導出函數\r\nexport const processCampaignData = (data) => {\r\n  if (!Array.isArray(data)) {\r\n    console.error(\"Input data is not an array\");\r\n    return { stats: [], best: null };\r\n  }\r\n\r\n  const stats = _(data)\r\n    .groupBy(\"Campaign Name\")\r\n    .map((campaign, name) => {\r\n      const totalImpressions = _.sumBy(campaign, \"Impressions\");\r\n      const totalClicks = _.sumBy(campaign, \"Clicks\");\r\n      const totalOrders = _.sumBy(campaign, \"7 Day Total Orders (#)\");\r\n      const totalSpend = _.sumBy(campaign, (row) =>\r\n        parseCurrencyValue(row[\"Spend\"])\r\n      );\r\n      const totalSales = _.sumBy(campaign, (row) =>\r\n        parseCurrencyValue(row[\"7 Day Total Sales \"])\r\n      );\r\n\r\n      return {\r\n        name,\r\n        impressions: totalImpressions,\r\n        clicks: totalClicks,\r\n        orders: totalOrders,\r\n        spend: totalSpend,\r\n        sales: totalSales,\r\n        CTR: calculateRate(totalClicks, totalImpressions),\r\n        CPC: totalClicks ? (totalSpend / totalClicks).toFixed(2) : 0,\r\n        ACOS: calculateRate(totalSpend, totalSales),\r\n        ROAS: totalSpend ? (totalSales / totalSpend).toFixed(2) : 0,\r\n        conversionRate: calculateRate(totalOrders, totalClicks),\r\n      };\r\n    })\r\n    .value();\r\n\r\n  return {\r\n    stats,\r\n    best: findBestPerformers(stats),\r\n  };\r\n};\r\n\r\n// 添加時間格式化函數\r\nconst formatDateTime = (date, hour) => {\r\n  // 確保 hour 是字符串且至少兩位數\r\n  const paddedHour = String(hour || \"00\").padStart(2, \"0\");\r\n  return `${date} ${paddedHour}:00:00`;\r\n};\r\n\r\nexport const processTrendData = (\r\n  data,\r\n  timeGranularity = \"day\",\r\n  compareMode = \"combined\"\r\n) => {\r\n  if (!Array.isArray(data)) {\r\n    console.error(\"Input data is not an array\");\r\n    return [];\r\n  }\r\n\r\n  return _(data)\r\n    .groupBy((row) => {\r\n      if (timeGranularity === \"hour\") {\r\n        // 使用 Start Date 和 Hour 組合作為分組依據\r\n        return formatDateTime(row[\"Start Date\"], row[\"Hour\"]);\r\n      }\r\n\r\n      const date = new Date(row[\"Start Date\"]);\r\n      switch (timeGranularity) {\r\n        case \"week\":\r\n          const weekStart = new Date(date);\r\n          weekStart.setDate(date.getDate() - date.getDay());\r\n          return weekStart.toISOString().split(\"T\")[0];\r\n        case \"month\":\r\n          return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(\r\n            2,\r\n            \"0\"\r\n          )}`;\r\n        default: // day\r\n          return row[\"Start Date\"];\r\n      }\r\n    })\r\n    .map((group, dateTime) => {\r\n      // 計算該時間點的總計數據\r\n      const totalSales = _.sumBy(group, (row) =>\r\n        parseCurrencyValue(row[\"7 Day Total Sales \"])\r\n      );\r\n      const totalSpend = _.sumBy(group, (row) =>\r\n        parseCurrencyValue(row[\"Spend\"])\r\n      );\r\n\r\n      const result = {\r\n        date: dateTime,\r\n        sales: totalSales,\r\n        spend: totalSpend,\r\n        ACOS:\r\n          totalSales > 0 ? ((totalSpend / totalSales) * 100).toFixed(2) : null,\r\n      };\r\n\r\n      // 如果是分開比較模式，添加各活動的數據\r\n      if (compareMode === \"separate\") {\r\n        result.campaignData = _(group)\r\n          .groupBy(\"Campaign Name\")\r\n          .mapValues((campaignGroup) => ({\r\n            sales: _.sumBy(campaignGroup, (row) =>\r\n              parseCurrencyValue(row[\"7 Day Total Sales \"])\r\n            ),\r\n            spend: _.sumBy(campaignGroup, (row) =>\r\n              parseCurrencyValue(row[\"Spend\"])\r\n            ),\r\n          }))\r\n          .value();\r\n      }\r\n\r\n      return result;\r\n    })\r\n    .orderBy([\"date\"], [\"asc\"])\r\n    .value();\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}